---
  title: 'Cox-Beta Model'
---
  
---

# Initialization 

In the first example, we use the Cox-Model and the `ovarian` data set from the 
`survival` package. In the first step we initialize the R6 data object. 

```{r, warning=FALSE, message=FALSE}
library(survival)
library(ggplot2)
library(cbr)

# all variables should be numeric or factor
ovarian$resid.ds <- factor(ovarian$resid.ds)
ovarian$rx <- factor(ovarian$rx)
ovarian$ecog.ps <- factor(ovarian$ecog.ps)

# initialize R6 object
sc <- cbrCoxModel$new(learning=ovarian, verumData=ovarian, learnVars=c("age", "resid.ds", "rx", "ecog.ps"), endPoint=c("futime", "fustat"), impute=F)
```
If `impute` is set to `FALSE` (for the Cox model the `Ã¬mpute` variable is always set to `FALSE`) then all cases with missing values in the learning and end point variables are dropped (`na.omit`) and the reduced data set without missing values is saved internally. You get a text output on how many cases were dropped. The variables should be `numeric` or `factor`. `character` variables will be transformed to `factor`.


# Similar Cases 

After the initialization, we may get for each case in verum data the most similar case from the learning data. 
```{r}
sc$getSimilarCases(nCases = 1)
```
You may extract then the similar cases and the verum data and put them together:
```{r, eval=FALSE}
verum <- sc$getVerumData()
verum$group <- "Verum"
simCases <- sc$simCases
simCases$caseId <- NULL
simCases$scDist <- NULL
simCases$group <- "Similar Cases"
df <- rbind(verum, simCases)
```
**Note 1:** In the initialization step, we dropped all cases with missing values in the variables of ` learnVars` and ` endPoint`. The function `sc$getVerumData()` returns the data set without the cases with missing values in the learning vars, except in the randomForest model where you have the option to impute missing values.

**Note 2:** The ` data.frame` returned from ` sc$simCases` has an additional column `caseId`. By this column you may map the similar cases to cases in verum data, e.g. if you had chosen ` nCases = 3`, then the first three elements in the column `caseId` will be ` 1` (following three ` 2` and so on). This means that this three cases are the three most similar cases to case ` 1` in verum data.

## Check Linearity and Proportional Hazard Assumption

There is one function for checking the proportional hazard assumption for all dependent variables. Actually, it is not able to correct for non-linearity in the distance calculation.

```{r, warning=FALSE, message=FALSE}
pp <- sc$check_ph()
pp
```

## Validation of the matching Variables

You may want to check the distibution of the ` learnVars` variables of the verum and similar cases data set:
```{r}
pp <- sc$validate()
pp
```
<br>
The function ` sc$validate()` returns an ` gg` and ` ggplot` object. 


# Distance Matrix

Alternatively, you may just be interested in the distance matrix, then you go this way:

```{r}
sc <- cbrCoxModel$new(learning=ovarian, verumData=ovarian, learnVars=names(ovarian)[-c(1, 2)], endPoint=c("futime", "fustat"), impute=F)
sc$getDistanceMatrix()
```
` sc$getFullDistanceMatrix()` calculates the full distance matrix. This matrix the dimension: cases of learning data versus cases of verum data. In the above example we used the same data set for learning and as verum data. Such case can also be achieved by:
```{r, eval=FALSE}
sc <- cbrCoxModel$new(learning=ovarian, learnVars=names(ovarian)[-c(1, 2)], endPoint=c("futime", "fustat"), impute=F)

sc$getDistanceMatrix()
```
The distance matrix is saved internally in the sc object: ` sc$distMat`.

<br>
